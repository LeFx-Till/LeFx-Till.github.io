<!--
  This one mainly based on https://github.com/taylordigital13/ARjs_Unity
  Fullscreen buttons are just simple png and the video is mpeg-4 baseline-profile with AAC audio.

  The video is placed on the Hiro marker and playback is stopped until the user clicks the play button.
  The same applies to losing and finding the marker again.

  Removed the iOS Message "Set your browser to request the mobile version of this site and reload to enjoy immersive mode."
!-->

<!DOCTYPE html>
<html>
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.0.0/aframe/build/aframe-ar.js"></script>

    <style>
        textarea {
            resize: none;
            position: absolute;
            top: 50px;
            left: 10px;
            right: 10px;
            width: inherit;
            text-align: left
        }
    </style>

    <script>

        var currentMarker = '';
        var currentMarkerID = '';
        var ready2play = 0;
        var currentVideo = '';
        var currentVideoEl = '';

        AFRAME.registerComponent('button', {

            init: function () {

                var button = document.querySelector("#mutebutton");
                var debugButton = document.querySelector("#debugbutton");
                var textArea = document.querySelector("#textArea");
                var assets = document.querySelector("a-assets");

                var isPlaying = false;
                const marker = this.el;

                button.hidden = true;
                debugButton.hidden = false;

                function PlayVideo() {

                    ready2play = 1;
                    button.hidden = false;
                    button.innerHTML = "-- PLAY VIDEO --";

                    button.addEventListener('click', function (evt) {
                                                
                        var video = document.querySelector("video");
                        textArea.innerHTML = "TRY PLAY VIDEO " + video.localName + " duration " + video.duration;

                        video.play();
                        
                        isPlaying = true;
                    });
                }

                function SetVideoAssetAttributes() {

                    textArea.innerHTML = "1. start creating video asset attributes";

                    currentVideo.id = 'Video_Asset_' + currentMarkerID;
                    currentVideo.autoplay = false;

                    if (currentMarkerID < 10) currentVideo.src = 'media/Video_00' + currentMarkerID + '.mp4';
                    else currentVideo.src = 'media/Video_0' + currentMarkerID + '.mp4';

                    currentVideo.loop = true;
                    currentVideo.setAttribute("crossorigin", "anonymous");
                    currentVideo.setAttribute("webkit-playsinline", "");
                    currentVideo.setAttribute("playsinline", "");
                    currentVideo.setAttribute("controls", "");
                    currentVideo.setAttribute("muted", "");
                    assets.appendChild(currentVideo);
                }

                function CreateVideoAssetListener() {

                    currentVideo.addEventListener('loadedmetadata', function (event) {

                        var width = this.videoWidth;
                        var height = this.videoHeight;

                        textArea.innerHTML += "\n2. done creating asset. inside listener";

                        currentVideoEl = document.createElement('a-video');
                        CreateVideoElementListener();
                        SetVideoElementAttributes(width, height);
                    });
                }

                function CreateVideoElementListener() {

                    currentVideoEl.addEventListener('loadedmetadata', function (event) {

                        currentVideoEl.object3D.position.set(0, 1.6, 0);
                        currentVideoEl.object3D.rotation.set(0, 0, 0);

                        textArea.innerHTML += "\n4. done creating element. inside listener";
                    });
                }

                function SetVideoElementAttributes(width, height) {

                    textArea.innerHTML += "\n\n3.start creating video element attributes";

                    currentVideoEl.id = 'Video_' + currentMarkerID;
                    currentVideoEl.setAttribute("class", "intersectable");

                    if (width < height) {

                        var widthEl = 3 * width / height;
                        currentVideoEl.setAttribute("width", String(widthEl));
                        currentVideoEl.setAttribute("height", "3");
                    }
                    else {

                        var heightEl = 3 * height / width;
                        currentVideoEl.setAttribute("width", "3");
                        currentVideoEl.setAttribute("height", String(heightEl));
                    }

                    currentVideoEl.setAttribute("transparent", "false");
                    currentVideoEl.setAttribute("color", "#FFFFFF");
                    currentVideoEl.src = '#' + currentVideo.id;

                    marker.appendChild(currentVideoEl);
                    PlayVideo();
                }

                marker.addEventListener('markerFound', () => {

                    var markerID = String(marker.id).split('_');
                    if (currentMarkerID != markerID[1]) {

                        currentMarkerID = markerID[1];
                        debugButton.innerHTML = "current marker id = " + currentMarkerID;

                        if (assets.childElementCount != 0)
                            assets.removeChild(assets.firstElementChild);

                        if (marker.childElementCount != 0)
                            marker.removeChild(marker.firstElementChild);

                        currentVideo = document.createElement("video");
                        CreateVideoAssetListener();
                        SetVideoAssetAttributes();
                    }
                    else {

                        textArea.innerHTML = "known video asset. assets child count = " + assets.childElementCount + " first asset child id = " + assets.firstElementChild.id;
                        debugButton.innerHTML = "SAME MARKER ID " + currentMarkerID;
                    }
                });

                marker.addEventListener('markerLost', () => {
                    debugButton.innerHTML = '_____';
                    textArea.innerHTML = "NO markers visible"; //\nnumber of video elements beneath marker = " + marker.childElementCount + "\ncurrent physical video = " + currentVideo.src;
                    isPlaying = false;
                    button.hidden = true;
                });
            },
        });

    </script>
</head>
<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>
    <div style='position: absolute; bottom: 10px; right: 30px; width:100%; text-align: center; z-index: 1;'>
        <button id="mutebutton" style='position: absolute; bottom: 10px' hidden>Play</button>
    </div>
    <div style='position: absolute; bottom: 50px; right: 30px; width:100%; text-align: center; z-index: 1;'>
        <button id="debugbutton" style='position: absolute; bottom: 50px' hidden>BITTE STARTE 2</button>
    </div>
    <textarea id="textArea" name="textArea" rows="10" cols="50">!!Again!!</textarea>
    <a-scene embedded arjs="debugUIEnabled: false; sourceType: webcam" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .intersectable; useWorldCoordinates: true;"></a-entity>

        <a-assets>
        </a-assets>

        <a-marker id="marker_0" type="pattern" url="marker/border_pattern_000.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_1" type="pattern" url="marker/border_pattern_001.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_2" type="pattern" url="marker/border_pattern_002.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_3" type="pattern" url="marker/border_pattern_003.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_4" type="pattern" url="marker/border_pattern_004.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_5" type="pattern" url="marker/border_pattern_005.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_6" type="pattern" url="marker/border_pattern_006.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_7" type="pattern" url="marker/border_pattern_007.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_8" type="pattern" url="marker/border_pattern_008.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_9" type="pattern" url="marker/border_pattern_009.patt" emitevents="true" button class="iOS"></a-marker>

        <a-marker id="marker_10" type="pattern" url="marker/border_polygons_001.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_11" type="pattern" url="marker/border_polygons_002.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_12" type="pattern" url="marker/border_polygons_003.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_13" type="pattern" url="marker/border_polygons_004.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_14" type="pattern" url="marker/border_polygons_005.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_15" type="pattern" url="marker/border_polygons_006.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_16" type="pattern" url="marker/border_polygons_007.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_17" type="pattern" url="marker/border_polygons_008.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_18" type="pattern" url="marker/border_polygons_009.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_19" type="pattern" url="marker/border_polygons_010.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_20" type="pattern" url="marker/border_polygons_011.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_21" type="pattern" url="marker/border_polygons_012.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_22" type="pattern" url="marker/border_polygons_013.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_23" type="pattern" url="marker/border_polygons_014.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_24" type="pattern" url="marker/border_polygons_015.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_25" type="pattern" url="marker/border_polygons_016.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_26" type="pattern" url="marker/border_polygons_017.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_27" type="pattern" url="marker/border_polygons_018.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_28" type="pattern" url="marker/border_polygons_019.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_29" type="pattern" url="marker/border_polygons_020.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_30" type="pattern" url="marker/border_polygons_021.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_31" type="pattern" url="marker/border_polygons_022.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_32" type="pattern" url="marker/border_polygons_023.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_33" type="pattern" url="marker/border_polygons_024.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_34" type="pattern" url="marker/border_polygons_025.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_35" type="pattern" url="marker/border_polygons_026.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_36" type="pattern" url="marker/border_polygons_027.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_37" type="pattern" url="marker/border_polygons_028.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_38" type="pattern" url="marker/border_polygons_029.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_39" type="pattern" url="marker/border_polygons_030.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_40" type="pattern" url="marker/border_polygons_031.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_41" type="pattern" url="marker/border_polygons_032.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_42" type="pattern" url="marker/border_polygons_033.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_43" type="pattern" url="marker/border_polygons_034.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_44" type="pattern" url="marker/border_polygons_035.patt" emitevents="true" button class="iOS"></a-marker>
        <a-marker id="marker_45" type="pattern" url="marker/border_polygons_036.patt" emitevents="true" button class="iOS"></a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let iOS = (isIOS = (/iPad|iPhone|iPod/.test(navigator.platform) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) && !window.MSStream) ? 1.5 : 0;
        if (iOS) {
            var incompatible = document.querySelector(".Android");
        } else {
            var incompatible = document.querySelector(".iOS");
        }
        incompatible.remove();
    </script>

</body>
</html>